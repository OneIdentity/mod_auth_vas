# $Id$
%define apxs 		     apxs2
%define apache 		     apache2
%define apache_libexecdir    %(%{apxs} -q LIBEXECDIR)
%define apache_sysconfdir    %(%{apxs} -q SYSCONFDIR)
%define apache_mmn           %(MMN=$(%{apxs} -q LIBEXECDIR)_MMN; test -x $MMN && $MMN)
%define apache_sysconfig     /etc/sysconfig/%{apache}
Vendor:		Quest Software, Inc.
Name:		apache2-mod_auth_vas
Version:	@VERSION@
Release:	1
License:	BSD
Group:		Productivity/Networking/Web/Servers
Requires:	%{apache} %{apache_mmn} 
Requires:	libvas.so.4
BuildRequires:	%{apache}-devel
BuildRequires:	vasdev
Summary:	Enables the Apache web server to authenticate users against Active Directory
URL:		http://rc.vintela.com/topics/mod_auth_vas/
BuildRoot:	%{_tmppath}/%{name}-%{version}-build
Prefix:		/opt/quest

%description
Enables the Apache web server to authenticate users against Active Directory

%prep
%build
%install
cd @abs_builddir@
make install DESTDIR=$RPM_BUILD_ROOT
make install-conf DESTDIR=$RPM_BUILD_ROOT confdir=%{apache_sysconfdir}/conf.d

%clean
rm -rf $RPM_BUILD_ROOT

%post
cf=%{apache_sysconfig}
sed -e '/APACHE_MODULES="/{/"auth_vas"/q;/"auth_vas "/q;/auth_vas"/q;s/="/="auth_vas /}' \
	<${cf} >${cf}.NEW
mv ${cf} ${cf}.orig
mv ${cf}.NEW ${cf}
#/etc/init.d/apache2 reload

%preun
cf=%{apache_sysconfig}
sed -e '/^APACHE_MODULES="/s/ auth_vas"/"/' \
    -e '/^APACHE_MODULES="/s/"auth_vas /"/' \
    -e '/^APACHE_MODULES="/s/"auth_vas"/""/' \
    -e '/^APACHE_MODULES="/s/ auth_vas / /' \
	<${cf} >${cf}.OLD
mv ${cf} ${cf}.OLD.orig
mv ${cf}.OLD ${cf}

%files
%defattr(-,root,root)
%dir %{apache_libexecdir}
%{apache_libexecdir}/mod_auth_vas.so
%attr(755,root,root) @sbindir@/setup-mod_auth_vas
%config(noreplace) %{apache_sysconfdir}/conf.d/auth_vas.conf
