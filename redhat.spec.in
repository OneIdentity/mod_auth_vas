# (c) 2006 Quest Software, Inc. All rights reserved.
Name:		mod_auth_vas
Version:	@VERSION@
Release:	1%{?apxs1:_ap1}%{!?apxs1:_ap2}
License:	BSD
Group:		Applications/Publishing
BuildPreReq:	%{?apxs1:apache-devel < 2} %{!?apxs1:httpd-devel >= 2}
PreReq:		%{?apxs1:apache < 2}       %{!?apxs1:httpd >= 2}
BuildPreReq:	vasdev
Requires:	libvas.so.4
Summary:	SPNEGO authentication for Apache using Active Directory
BuildRoot:	%{_tmppath}/%{name}-%{version}-root
AutoReq:	no
Prefix:		/opt/quest

%define apxs 			@APXS@
%define apache_libdir		%(%{apxs} -q LIBEXECDIR)
%define apache_sysconfdir	%(%{apxs} -q SYSCONFDIR)

%description
mod_auth_vas authenticates Active Directory users,
and can restrict file access by user, organisational unit, AD domain or
group.

%prep 
%build
%install
cd @abs_builddir@
make install DESTDIR=$RPM_BUILD_ROOT
make install-conf DESTDIR=$RPM_BUILD_ROOT \
		  confdir=%{apache_sysconfdir}.d

#-- unlike suse, we have to add the LoadModule explicitly
ed -s $RPM_BUILD_ROOT%{apache_sysconfdir}.d/auth_vas.conf <<_end
1i
LoadModule auth_vas_module modules/mod_auth_vas.so
.
w
_end

%clean
rm -rf $RPM_BUILD_ROOT

%post
case "$1" in
 1)
    #-- For apache-1.3.x, we need to insert the include line
    if ! grep '^LoadModule.*mod_auth_vas' \
		%{apache_sysconfdir}/httpd.conf >/dev/null && \
       ! grep '^Include.*conf\.d/\*' \
		%{apache_sysconfdir}/httpd.conf >/dev/null
    then
	cat >> %{apache_sysconfdir}/httpd.conf <<_end_mav

# Added by %{name}-%{version}
<IfDefine HAVE_AUTH_VAS>
Include %{apache_sysconfdir}.d/auth_vas.conf
</IfDefine>
_end_mav
    fi
    ;;
esac
#/etc/init.d/httpd reload

#if test ! -e /etc/sysconfig/httpd || 
#        ! (. /etc/sysconfig/httpd && 
#	   echo "$HTTPD" | grep libvas > /dev/null) 2>/dev/null
#then
#    (echo
#     echo '# The following line may be needed for %{name}-%{version}'
#     echo '#HTTPD="env LD_PRELOAD=/opt/vintela/vas/lib/libvas.so $HTTPD"'
#    ) >> /etc/sysconfig/httpd
#    echo "** Please check the end of /etc/sysconfig/httpd" >&2
#fi

#%preun
#if test "$1" -eq 0; then
#  if test -f /etc/init.d/.httpd.backup_%{name}; then
#      mv -f /etc/init.d/httpd /etc/init.d/.httpd.rpmsave.%{name}
#      mv -f /etc/init.d/.httpd.backup_%{name} /etc/init.d/httpd
#  fi
#fi
#/etc/init.d/httpd restart	#-- reload server?


%files
%defattr(-,root,root)
%dir %{apache_libdir}
%{apache_libdir}/mod_auth_vas.so
%attr(755,root,root) @sbindir@/setup-mod_auth_vas
%dir %{apache_sysconfdir}.d/
%config(noreplace) %{apache_sysconfdir}.d/auth_vas.conf

